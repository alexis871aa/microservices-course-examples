# Примеры работы с PostgreSQL в Go

В этой директории содержатся примеры по работе с PostgreSQL из Go-приложения, демонстрирующие различные подходы к взаимодействию с базой данных.

## Структура проекта

```
week_3/postgres/
├── cmd/                        # Исполняемые приложения
│   ├── raw_query/              # Пример с использованием "сырых" SQL-запросов
│   └── query_with_squirrel/    # Пример с использованием SQL-конструктора Squirrel
├── internal/                   # Внутренние пакеты приложения
│   └── migrator/               # Пакет для управления миграциями БД
├── migrations/                 # SQL-миграции базы данных
├── bin/                        # Директория для бинарных утилит
├── docker-compose.yml          # Конфигурация Docker Compose для PostgreSQL
├── Taskfile.yaml               # Файл задач для управления проектом
└── .golangci.yml               # Конфигурация линтера
```

## Примеры кода

В директории представлены два основных примера:

### 1. Работа с "сырыми" SQL запросами (raw_query)

Пример демонстрирует базовое взаимодействие с PostgreSQL с использованием стандартного пакета `database/sql` и драйвера `pgx`. Показаны:
- Подключение к базе данных
- Применение миграций
- Выполнение простых SQL-запросов (INSERT, SELECT)
- Обработка результатов запросов

### 2. Работа с SQL-конструктором Squirrel (query_with_squirrel)

Пример демонстрирует работу с базой данных с использованием SQL-конструктора `Squirrel`, который позволяет формировать SQL-запросы программно. Показаны:
- Построение INSERT-запросов с возвращаемыми значениями
- Построение SELECT-запросов с условиями и ограничениями
- Построение UPDATE-запросов
- Построение DELETE-запросов с условиями для удаления конкретных записей
- Безопасная работа с параметрами запросов

## Миграции базы данных

В проекте используется библиотека `goose` для управления миграциями. Миграции находятся в директории `migrations/`:
- Создание таблицы `note` с полями: id, title, body, created_at, updated_at

## Docker и Docker Compose

Проект включает настройки Docker Compose для быстрого развертывания PostgreSQL:
- Использует образ PostgreSQL 15
- Настраивает переменные окружения через .env-файл
- Монтирует том для сохранения данных
- Настраивает healthcheck и автоматический перезапуск

## Запуск примеров

### Подготовка

1. Создайте файл `.env` в корне директории со следующим содержимым:
```
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_PORT=5432
DB_URI=postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable
MIGRATIONS_DIR=./migrations
```

2. Запустите PostgreSQL через Docker Compose:
```bash
task docker:compose:up
```

### Запуск примеров

1. Запуск примера с "сырыми" SQL запросами:
```bash
go run cmd/raw_query/main.go
```

2. Запуск примера с Squirrel:
```bash
go run cmd/query_with_squirrel/main.go
```

## Полезные команды (task)

- `task format` - форматирует код
- `task lint` - запускает линтер
- `task docker:compose:up` - запускает контейнеры Docker Compose
- `task docker:compose:down` - останавливает и удаляет контейнеры Docker Compose
- `task docker:compose:build` - пересобирает контейнеры Docker Compose

## Используемые технологии

- **pgx** - драйвер PostgreSQL для Go
- **squirrel** - SQL-конструктор запросов
- **goose** - инструмент для миграций базы данных
- **godotenv** - загрузка переменных окружения из .env файла
- **gofakeit** - генерация тестовых данных 